!function(e,t){"object"==typeof module&&"function"==typeof module.exports?module.exports=t(e):window.WebShop=t(e)}(window||this,function(e){var t,n,o,i,r,a,d,s,c,l,p,u,f=document.body,x=new THREE.Raycaster,m=[],h={},y={objUrl:null,infoUrl:null,index:0,gap:400,isFloor:!0,isReset:!0,isBack:!0,cameraPosition:{x:0,y:100,z:400}};if(!e.document)throw new Error("此插件必须运行在有document的浏览器环境下");var w=function(e){return new w.prototype.init(e)};return w.prototype={init:function(a){t=this,y=Object.assign({},y,a),d=y.index,(i=new THREE.Scene).updateMatrixWorld(!0),(n=new THREE.PerspectiveCamera(45,e.innerWidth/e.innerHeight,1,2e4)).position.set(y.cameraPosition.x,y.cameraPosition.y,y.cameraPosition.z),(c=new THREE.Group).add(n),i.add(c);var s=new THREE.AmbientLight(11908533);i.add(s);var l=new THREE.PointLight(4473924);return l.position.set(-100,1500,100),c.add(l),(o=new THREE.WebGLRenderer({antialias:!0})).setClearColor(16777215),o.setPixelRatio(e.devicePixelRatio),o.setSize(e.innerWidth,e.innerHeight),f.appendChild(o.domElement),f.style.cssText="margin:0;padding:0;overflow:hidden;position:fixed;width:100vw;height:100vh;",(u=document.createElement("div")).style.cssText="position:absolute;left:0;top:0;height:0;color:#000000;",document.body.appendChild(u),(r=new THREE.OrbitControls(n,o.domElement)).dispose(),r.update(),this.loadObj(),this.bindEvent(),this.animate(),t},loadObj:function(e){e=[];var n=[];if(!y.objUrl)throw new Error("没有传入obj模型");if("string"==typeof y.objUrl)e.push(y.objUrl);else{if("[object Array]"!==Object.prototype.toString.call(y.objUrl))throw new Error("objUrl类型错误，请传入字符串或数组对象");e=y.objUrl}if("string"==typeof y.infoUrl)n.push(y.infoUrl);else{if("[object Array]"!==Object.prototype.toString.call(y.infoUrl))throw new Error("infoUrl类型错误，请传入字符串或数组对象");n=y.infoUrl}var o=new THREE.LoadingManager;o.onProgress=function(e,t,n){console.log(e,t,n)};var i,r=new THREE.TDSLoader(o);Promise.all((i=[],n.forEach(function(e){i.push(new Promise(function(t,n){var o,i,r,a;o=e,i=t,r=n,(a=new XMLHttpRequest).open("GET",o,!0),a.onerror=r,a.timeout=r,a.onload=function(e){i(e.target.response)},a.send(null)}))}),i)).then(function(t){return Promise.all((o=[],n=(n=t).map(function(e){return JSON.parse(e)}),e.forEach(function(e,t){o.push(new Promise(function(o,i){r.load(e,function(e){e.infos=n[t],o(e)},onprogress,function(e){i(e)})}))}),o));var n,o}).then(function(e){t.loadObjhandler(e)}).catch(function(e){throw alert("加载模型失败"),console.log(e),new Error("模型加载失败"+JSON.stringify(e))})},loadObjhandler:function(e){e.forEach(function(e,n){var o=e.infos;e.index=n,e.position.y=n*y.gap,e.traverse(function(n){if(n instanceof THREE.Mesh&&o[n.name]){var i=o[n.name];n.material=new THREE.MeshLambertMaterial,n.material.color.setHex("0x"+i.color),i.name&&(n.myName=i.name,n.geometry.computeBoundingBox(),n.geometry.boundingBox.getSize(),n.peak=t.computePeak(n.geometry.boundingBox,e.position),m.push(n))}}),i.add(e)}),a=e,t.addLocal(),t.updateText(),y.isFloor&&t.addFloor(),y.isReset&&t.addReset(),y.isBack&&t.addBack(),t.emit("done",e)},addFloor:function(){var e=document.createElement("ul");e.style.cssText="position:fixed;left:10px;bottom:50px;z-index:9;overflow-x:hidden;overflow-y:scroll;width:30px;background:#34495E;border-radius:4px;padding:0;margin:0;list-style:none;max-height:120px;color:#fff;",a.forEach(function(n,o){var i=document.createElement("li");i.style.cssText="display:block;width:100%;height:30px;text-align:center;line-height:30px;"+(0!==o?"border-bottom:1px solid #ddd;":""),i.innerText=o+1+"F",i.onclick=function(e){e.stopPropagation(),t.setIndex(o)},e.insertBefore(i,e.lastChild)}),document.body.appendChild(e)},addReset:function(){var e=document.createElement("div");e.style.cssText="position:fixed;right:10px;bottom:100px;background:#34495E;border-radius:50%;width:40px;height:40px;text-align:center;line-height:40px;color:#fff;font-size:10px;",e.innerText="重置",e.onclick=function(e){e.stopPropagation(),t.reset()},document.body.appendChild(e)},addBack:function(){var e=document.createElement("div");e.style.cssText="position:fixed;right:10px;bottom:50px;background:#34495E;border-radius:50%;width:40px;height:40px;text-align:center;line-height:40px;color:#fff;font-size:10px;",e.innerText="返回",e.onclick=function(){history.go(-1)},document.body.appendChild(e)},addLocal:function(){var e=new THREE.SphereGeometry(3,64,64),t=new THREE.MeshLambertMaterial({color:16711680});(s=new THREE.Mesh(e,t)).position.y=3+d*y.gap,i.add(s)},getLocal:function(){return{x:s.position.x,y:s.position.y}},setLocal:function(e,n,o){o&&t.setIndex(o),s.position.set(e||0,o?3+o*y.gap:3,n||0)},raycastFn:function(){if(l){x.setFromCamera(l,n);var e=x.intersectObjects(m);e.length>0?p!=e[0].object&&(p&&p.material.color.setHex(p.currentHex),(p=e[0].object).currentHex=p.material.color.getHex(),p.material.color.setHex(10021119),t.setIndex(p.parent.index)):(p&&p.material.color.setHex(p.currentHex),p=null)}},lookAt:function(e){t.hideText(),createjs.Tween.get(c.position).to({x:a[d].position.x,y:a[d].position.y,z:a[d].position.z},600,createjs.Ease.sineInOut).call(function(){e&&e(),t.updateText(),t.showText()})},addAxes:function(){var e=new THREE.AxesHelper(2e3);i.add(e);var t=new THREE.CameraHelper(n);i.add(t)},animate:function(){requestAnimationFrame(function(){t.animate()}),r.update(),t.render()},render:function(){n.updateMatrixWorld(),o.render(i,n)},updateText:function(){if(!(m.length<=0)){n.position;m.forEach(function(e){if(!1!==e.dom)if(e.parent.index==d)if(e.dom){if(!1===(n=t.toScreen(e.peak)))return e.dom.style.display="none";e.dom.style.cssText="position:absolute;left:"+n.x+"px;top:"+n.y+"px;transform:translate(-50%,-50%);font-size:1.92vw;white-space: nowrap;"}else{var n=t.toScreen(e.peak),o=document.createElement("div");o.innerText=e.myName,!1===n?o.style.display="none":o.style.cssText="position:absolute;left:"+n.x+"px;top:"+n.y+"px;transform:translate(-50%,-50%);font-size:1.92vw;white-space: nowrap;",u.appendChild(o),e.dom=o}else e.dom&&(e.dom.style.display="none")})}},showText:function(){u.style.display="block"},hideText:function(){u.style.display="none"},setIndex:function(e,n){void 0!==e&&e!==d&&(d=e,t.lookAt(n))},done:function(e){return this.on("done",e),t},bindEvent:function(){var e,i,a,d=new Hammer(o.domElement);d.get("pinch").set({enable:!0}),d.get("rotate").set({enable:!0}),document.body.addEventListener("click",function(e){(l=new THREE.Vector2).x=e.pageX/window.innerWidth*2-1,l.y=-e.pageY/window.innerHeight*2+1,t.raycastFn()}),d.on("panstart",function(t){e=!0,u.style.display="none",r.panStart(t)}),d.on("panmove",function(t){e&&r.panMove(t)}),d.on("panend",function(n){e&&(r.panEnd(n),t.updateText(),u.style.display="block",e=!1)}),d.on("rotatestart",function(e){i=!0,u.style.display="none",r.rotateStart(e)}),d.on("rotatemove",function(e){i&&r.rotateMove(e)}),d.on("rotateend",function(e){i&&(r.rotateEnd(e),t.updateText(),u.style.display="block",i=!0)}),d.on("pinchstart",function(e){a=!0,u.style.display="none",r.scaleStart(e)}),d.on("pinchmove",function(e){a&&r.scaleMove(e)}),d.on("pinchend",function(e){a&&(t.updateText(),u.style.display="block",a=!1)}),window.addEventListener("resize",function(){n.aspect=window.innerWidth/window.innerHeight,n.updateProjectionMatrix(),o.setSize(window.innerWidth,window.innerHeight),t.updateText()})},reset:function(){r.reset(),r.update(),d===y.index?t.updateText():(d=y.index,t.lookAt())},emit:function(e,n){e&&h[e]&&h[e].length>0&&h[e].forEach(function(e){e&&e.call(t,n)})},on:function(e,t){h[e]||(h[e]=[]),h[e].push(t)},toScreen:function(e){var t=new THREE.Vector3(e.x,e.y,e.z).project(n);if(t.x>=-1&&t.x<=1&&t.y<=.4&&t.z>=-1&&t.z<=1){var o=window.innerWidth/2,i=window.innerHeight/2;return{x:Math.round(t.x*o+o),y:Math.round(-t.y*i+i)}}return!1},computePeak:function(e,t){var n={min:{x:e.min.x+t.x,y:e.min.y+t.y,z:e.min.z+t.z},max:{x:e.max.x+t.x,y:e.max.y+t.y,z:e.max.z+t.z}};return{x:(e.max.x+e.min.x)/2,y:n.max.y,z:(e.max.z+e.min.z)/2}},clone:function(e){if(void 0===e||null===e)return null;if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return e;var t={};for(var n in e)t[n]=e[n];return t}},w.prototype.init.prototype=w.prototype,w});